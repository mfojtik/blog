<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<title> Avoiding anti-patterns in Ruby - Arrays &middot; mfojtik blog </title>


<link rel="stylesheet" href="http://mfojtik.io/css/slim.css">
<link rel="stylesheet" href="http://mfojtik.io/css/highlight.min.css">
<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Source+Code+Pro' rel='stylesheet' type='text/css'>

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="/favicon.ico">

</head>

<body>
  <div class="container">
    <div class="header">
  <h1 class="site-title"><a href="http://mfojtik.io">mfojtik blog</a></h1>
  <p class="site-tagline"><em>Look at you, hacker. A pathetic creature of meat and bone, panting and sweating as you run through my corridors. How can you challenge perfect immortal machine</em></p>
  <div class="nav">
    <a class="nav-btn" href="#">
      <span class="ci ci-burger"></span>
    </a>
    <ul class="nav-list">
       
	  <li class="spacer">&ac;</li>

      <li><a href="https://github.com/mfojtik">Github</a></li> 
      <li><a href="https://twitter.com/mfojtik">Twitter</a></li> 
    </ul>
  </div>
</div>

    <div class="content">
      <div class="posts">
        <div class="post">
          <h2 class="post-title"><a href="http://mfojtik.io/post/avoiding-anti-patterns-in-ruby/">Avoiding anti-patterns in Ruby - Arrays</a></h2>
          <span class="post-date">Mar 21, 2012 </span>
          <div class="post-content">
            

<p>Since I came to Ruby from the Java and PHP world I&rsquo;ve found many expressions
used in Ruby cryptic and I&rsquo;ve been trying to avoid them in my daily life.
After years and thousand lines of Ruby code I&rsquo;ve read, I feel a need to change
the way I write the code. I want to make my code look better, readable
and preferably save some keystrokes.</p>

<blockquote>
<p>In software engineering, an anti-pattern (or antipattern) is a pattern that
may be commonly used but is ineffective and/or counterproductive in practice.
<a href="http://en.wikipedia.org/wiki/Anti-pattern">wikipedia</a></p>
</blockquote>

<h2 id="for-each-or-map">For, each or map?</h2>

<p>Iteration is the perfect example of what I should improve. When I started writing
the Ruby code, I was used to write constructions like this:</p>

<pre class="sh_ruby">
  fruits = ['apple', 'cherry', 'peach', 'orange']

  for fruit in fruits do
    puts fruit
  end
</pre>

<p>This is syntactically perfect Ruby code. Also for the PHP/Java newcomers it looks
perfectly safe. However, it&rsquo;s not what the rest of the Ruby programmers usually
write. As you may already know, Ruby is an object-oriented language and <code>[]</code> in
Ruby is just an alias for the <code>Array.new</code>. If you look to the <a href="http://www.ruby-doc.org/core-1.9.3/Array.html">Array</a>
class documentation, you will find many interesting methods I want to describe
below:</p>

<p><strong><code>.each</code></strong></p>

<p>The &lsquo;each&rsquo; method can be used for iterating the Array in case you don&rsquo;t want to
return anything from the iteration block:</p>

<pre class="sh_ruby">
  [1,2,3].each { |i| i+1 }
  # => [1,2,3]
</pre>

<p>This method is good if you want to modify some object outside the iteration block,
or just call some method without caring to much about what the method returns,
like:</p>

<pre class="sh_ruby">
  [inst1, inst2, inst3].each { |i| i.stop! }
</pre>

<p>For example, you can create an alias in Array for <code>.each</code>:</p>

<pre class="sh_ruby">
  class Array
    alias_method :each_instance, :each
  end

  [inst1, inst2, inst3].each_instance { |instance| instance.stop! }
</pre>

<p>This will immediately yell on you what this code is trying to do.
Please do not use this method for changing the content of variables or creating
new arrays.</p>

<p>In most cases, the <code>.each</code> method can be replaced with some of the
methods bellow:</p>

<p><strong><code>.map</code></strong></p>

<p>There are cases when you want to modify the content of an Array and return the
modified content. In PHP, you usually do a clone of the Array or create a new array
with updated items. In Ruby this is not necessary:</p>

<pre class="sh_ruby">
  a = [1,2,3,4,5]
  result = []
  a.each do |i|
    result << i+1
  end
  result # => [2,3,4,5,6]
</pre>

<p>As you may guess, there are few glitches in this code. First, you create a new
variable (mean you allocate space for it). In many cases you also leave the
variable <code>a</code> abandoned, stealing your memory quietly. The right Ruby approach
is to use the <code>.map</code> method:</p>

<pre class="sh_ruby">
  a = [1,2,3]
  a.map { |i| i+1 } # => [2, 4, 5]
</pre>

<p>The <code>.map</code> method here iterates through array and gives you chance to modify
the content of it. Then it returns the modified Array back to you, but keeps
the original content of <code>a</code> variable untouched.
If you don&rsquo;t want to return anything, but just want to modify the original array
instead, use the <code>.map!</code> method:</p>

<pre class="sh_ruby">
  a = [1,2,3]
  a.map! { |i| i+1 }
  puts a.inspect # => [2, 4, 5]
</pre>

<p><strong><code>.any?</code></strong></p>

<p>The next anti-pattern commonly seen by Ruby newcomers, is to use <code>.each</code> to iterate
through the Array and return a boolean when it finds a match:</p>

<pre class="sh_ruby">
  def find_odd_number(arr)
    arr.each do |i|
      return true unless i.odd?
    end
  end
</pre>

<p>Please keep in mind that the <code>return</code> statement is used <strong>only</strong> for returning
from a method or Proc/lambda. And you should then use this statement in the
context of this method, not in the context of the <code>.each</code> block.
The correct Ruby approach here would be to use the <code>any?</code> method to search the
array:</p>

<pre class="sh_ruby">
  def find_odd_number(arr)
    arr.any? { |i| !i.odd? }
  end
</pre>

<p>The example above returns <code>true</code> if there is an odd number in the array. No
need to write over-complicated <code>.each</code> iterations.</p>

<p>The ultimate main goal of every Ruby programmer who care about the code he is
writing is to make the reader of his code understand what the author is trying to
say (without using comments). Ruby offers many &lsquo;syntax&rsquo; sugar methods to achieve
this goal. For example:</p>

<pre class="sh_ruby">
  a = [1,2,3]
  a.reject { |i| i == 2 } # => [1, 3]
  a.keep_if { |i| [1,2].include?(i) } # => [1, 2]
  a.find { |i| i == 2 } # => 2
</pre>

<p>As you can see, Ruby is trying to be very descriptive for the reader, so you
don&rsquo;t need to read too much code to get a clue what the code is trying to do.</p>

<p>There are many <a href="http://ruby.about.com/od/rubyfeatures/a/aliasing.htm">aliases</a>
that can help you to make your code more readable. For example the
<a href="http://www.ruby-doc.org/core-1.9.3/Array.html#method-i-index"><code>.index</code></a> method,
that will return a position of the element inside the Array is just an alias for
the <code>.find_index</code> method. If it makes your code more readable, you&rsquo;re free to use
this alias instead of the original method.</p>

<p>In Ruby Array class you can find more handy aliases. For example if you want to
access first or last item of the array, you can think about writing this:</p>

<pre class="sh_ruby">
  a = [ 'a', 'b', 'c', 'd' ]
  puts a[0] # => 'a'
  puts a[a.size-1] # => 'd'
</pre>

<p>Since the indexing of arrays in Ruby starts from zero, the programmer may know
that you&rsquo;re trying to access first element. But why make people think about
indexing numbers? For example, you can use the <code>.first</code> method in Array to
retrieve the first item. In this case, it doesn&rsquo;t really matter what is the
index number of first element:</p>

<pre class="sh_ruby">
  a = [ 'a', 'b', 'c', 'd' ]
  puts a.first # => 'a'
</pre>

<p>The same thing applies for the last item in array. As you might see in the first
example, the calculation is quite strange and it does not yell on you that you
want to return the last element. So there is the <code>.last</code> method that will hide this
calculation for you and yell on the reader that you want to access the last element.</p>

<p>So a quick summary:</p>

<ul>
<li><p>Use the <code>.each</code> method only when you&rsquo;re not modifying any variable in the current
context. Modifying the state of an object using exclamation mark methods is
perfect use-case for this.</p></li>

<li><p>Use <code>.map</code> when you need to modify content of a variable or return a modified
version of the array. This method has also an alias <code>.select</code>. Use it if it
makes your code more readable.</p></li>

<li><p>Use <code>.any?</code> when you&rsquo;re searching for an item in the array that matches to
given condition. If you&rsquo;re doing a simple search, you can also proceed with <code>.include?</code></p></li>

<li><p>Look to the Array docs every time you&rsquo;re doing something nasty with <code>.each</code>.
There will always be a method that will do better a job with less amount of code.</p></li>

<li><p>Try to avoid accessing elements in array using the array index. If you want to
get the last or first item, there is a helper for that.</p></li>
</ul>

          </div>
        </div>
        <div class="pagination">
          <a class="btn previous " href="http://mfojtik.io/post/deltacloud-api-using-sinatra-modular-app/"> Prev</a>  
          <a class="btn next " href="http://mfojtik.io/post/creating-rest-based-api-with-sinatra-rabbit/"> Next</a> 
        </div>
      </div>
    </div>
    
    <div class="footer">
  <p>Powered by <a href="http://gohugo.io">hugo</a> and the <a
    href="https://github.com/zhe/hugo-theme-slim">slim</a> theme.</p>
</div>

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-109743259-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-109743259-2');
</script>

  </div>
  <script src="http://mfojtik.io/js/slim.js"></script>
  <script src="http://mfojtik.io/js/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
  
</body>

</html>
